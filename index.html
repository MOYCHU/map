<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Melbourne Parking Map with Routing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%;
            font-family: Arial, sans-serif;
        }
        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar-container {
            width: 280px;
            margin: 12px auto;
            border-radius: 12px;
            border: 1px solid #bbb;
            background-color: #f0f0f0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            max-height: 40px;
            transition: max-height 0.35s ease;
            overflow: hidden;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #sidebar-container.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        #sidebar-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, #355c7d, #6c5b7b);
            color: #fff;
            font-weight: 600;
            font-size: 17px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            user-select: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: background 0.3s ease;
        }
        #sidebar-header:hover {
            background: linear-gradient(135deg, #4a739c, #8c739c);
        }

        #sidebar-arrow {
            transition: transform 0.35s ease;
            font-weight: bold;
            font-size: 18px;
        }
        #sidebar-container.expanded #sidebar-arrow {
            transform: rotate(90deg);
        }

        #parking-list {
            list-style: none;
            margin: 8px 12px 16px 12px;
            padding: 0;
        }
        #parking-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.25s, box-shadow 0.25s;
            font-size: 15px;
        }
        #parking-list li:hover {
            background-color: #d3e3ff;
            box-shadow: 0 2px 5px rgba(53, 92, 125, 0.3);
        }
        .status-box {
            min-width: 70px;
            padding: 4px 10px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-align: center;
            user-select: none;
        }
        .status-Unoccupied {
            background-color: #00AA00;
        }
        .status-Present {
            background-color: #D70000;
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        .leaflet-control-custom {
            background-color: white;
            border: 2px solid #007bff;
            border-radius: 50%;    /* 大圆 */
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
        }

        .loc-icon {
            width: 12px;
            height: 12px;
            background-color: #007bff;
            border-radius: 50%;
        }

        .leaflet-control-custom:hover {
            background-color: #007bff;
            color: white;
        }
   
        .loc-icon {
            width: 14px;
            height: 14px;
            position: relative;
        }

        .loc-icon:before, .loc-icon:after {
            content: '';
            position: absolute;
            background-color: #007bff;
        }
        .leaflet-control-custom:hover .loc-icon:before,
        .leaflet-control-custom:hover .loc-icon:after {
            background-color: white;
        }
        .loc-icon:before {
            left: 6px;
            top: 0;
            width: 2px;
            height: 14px;
        }
        .loc-icon:after {
            top: 6px;
            left: 0;
            width: 14px;
            height: 2px;
        }

        .leaflet-routing-container {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
        }

    </style>
</head>
<body>

    <div id="sidebar-container">
        <div id="sidebar-header">
            Closest 20 Parking Bays
            <span id="sidebar-arrow">▶</span>
        </div>
        <ul id="parking-list"></ul>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        const userLatLng = [-37.8105, 144.9624];
        const map = L.map('map').setView(userLatLng, 18);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        const userMarker = L.circleMarker(userLatLng, {
            radius: 10,
            color: '#007bff',
            weight: 3,
            fillColor: '#3399ff',
            fillOpacity: 0.8
        }).addTo(map).bindPopup('Your Location: Melbourne Central').openPopup();

        const markerGroup = L.layerGroup().addTo(map);

        const statusColor = {
            "unoccupied": "#00AA00",  // 绿：无车
            "present": "#D70000"      // 红：有车
        };

        // calculate distance
        function getDistance(lat1, lon1, lat2, lon2) {
            function toRad(x) { return x * Math.PI / 180; }
            const R = 6371e3;
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);
            const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString('en-AU', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(',', '');
        }

        const parkingListElem = document.getElementById('parking-list');
        const sidebarContainer = document.getElementById('sidebar-container');
        const sidebarHeader = document.getElementById('sidebar-header');
        const sidebarArrow = document.getElementById('sidebar-arrow');

        sidebarHeader.addEventListener('click', () => {
            sidebarContainer.classList.toggle('expanded');
        });

        // Global routing Control
        let routingControl = null;

        // Draw route

        function showRouteTo(lat, lng) {
            if (routingControl) {
                map.removeControl(routingControl);
            }
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLatLng[0], userLatLng[1]),
                    L.latLng(lat, lng)
                ],
                routeWhileDragging: false,
                draggableWaypoints: false,
                addWaypoints: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{color: 'blue', opacity: 0.7, weight: 5}]
                }
            }).addTo(map);
        }

        async function loadParkingData() {
            try {
                const limit = 100;
                let offset = 0;
                let total = null;
                let allRecords = [];

                while (true) {
                    const url = `https://data.melbourne.vic.gov.au/api/explore/v2.1/catalog/datasets/on-street-parking-bay-sensors/records?limit=${limit}&offset=${offset}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!data.results) {
                        console.error("API error:", data);
                        break;
                    }

                    if (total === null) total = data.total_count;

                    allRecords = allRecords.concat(data.results);

                    offset += limit;
                    if (offset >= total) break;
                }

                renderMarkers(allRecords);
                updateParkingList(allRecords);

            } catch (err) {
                console.error("Failed to load parking data:", err);
            }
        }

        function renderMarkers(records) {
            markerGroup.clearLayers();
            records.forEach(r => {
                if (!r.location) return;

                const lat = r.location.lat;
                const lng = r.location.lon;

                if (typeof lat !== 'number' || typeof lng !== 'number') return;

                const status = (r.status_description || '').toLowerCase();
                const color = statusColor[status] || "blue";

                const popupContent = `
                    <b>Status:</b> ${r.status_description || 'N/A'}<br/>
                    <b>Last Updated:</b> ${formatDateTime(r.status_timestamp)}<br/>
                    <b>Zone Number:</b> ${r.zone_number ?? 'N/A'}<br/>
                    <b>Kerbside ID:</b> ${r.kerbsideid ?? 'N/A'}
                `;

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    color: "white",
                    weight: 1,
                    fillColor: color,
                    fillOpacity: 0.9
                }).bindPopup(popupContent);

                marker._customData = r;
                markerGroup.addLayer(marker);
            });
        }

        function updateParkingList(records) {
            const validRecords = records.filter(r => r.location && typeof r.location.lat === 'number' && typeof r.location.lon === 'number');

            validRecords.forEach(r => {
                r.distanceToUser = getDistance(userLatLng[0], userLatLng[1], r.location.lat, r.location.lon);
            });

            const closest20 = validRecords.sort((a,b) => a.distanceToUser - b.distanceToUser).slice(0, 20);

            parkingListElem.innerHTML = '';

            closest20.forEach((r, index) => {
                const li = document.createElement('li');

                // 创建状态小方块
                const statusBox = document.createElement('div');
                const statusText = r.status_description || 'Unknown';
                // CSS类名区分大小写，注意首字母大写
                const statusClass = ['Unoccupied', 'Present'].includes(statusText) ? `status-${statusText}` : 'status-default';
                statusBox.className = `status-box ${statusClass}`;
                statusBox.textContent = statusText;

                li.innerHTML = `${index + 1}. ${r.distanceToUser.toFixed(0)} m`;
                li.appendChild(statusBox);

                li.addEventListener('click', () => {
                    const lat = r.location.lat;
                    const lng = r.location.lon;
                    map.setView([lat, lng], 20);

                    markerGroup.eachLayer(marker => {
                        if (marker._customData && marker._customData.kerbsideid === r.kerbsideid) {
                            marker.openPopup();
                        }
                    });

                    showRouteTo(lat, lng);
                });

                parkingListElem.appendChild(li);
            });
        }

        // Back to current location

        const locateControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
                container.title = "Go to Your Location";
                container.innerHTML = `<div class="loc-icon"></div>`;

                container.onclick = function() {
                    map.setView(userLatLng, 18, {animate: true});
                    userMarker.openPopup();

                };

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        map.addControl(new locateControl());

        loadParkingData();
        setInterval(loadParkingData, 300000);
    </script>
</body>
</html>
